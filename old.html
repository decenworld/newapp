<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Clicker Telegram Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/idb@7.1.1/build/idb.min.js" type="text/javascript"></script>
    <style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
        background-color: #1e3a5f;
        color: white;
        overflow: hidden;
    }
    .container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: linear-gradient(to bottom, #1e3a5f, #0c1c2e);
    }
    .header {
        padding: 10px;
        text-align: center;
        background-color: rgba(0,0,0,0.3);
        text-shadow: 2px 2px 2px rgba(0,0,0,0.5);
    }
    .cookie-count {
        font-size: 28px;
        font-weight: bold;
    }
    .cps {
        font-size: 18px;
    }
    .cookie-area {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }
    .cookie {
        width: 250px;
        height: 250px;
        background-image: url('https://static.wikia.nocookie.net/cookieclicker/images/5/5a/PerfectCookie.png');
        background-size: cover;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .cookie:active {
        transform: scale(0.95);
    }
    .navbar {
        display: flex;
        justify-content: space-around;
        padding: 10px;
        background-color: #333;
        border-top: 2px solid #555;
    }
    .nav-item {
        text-align: center;
        cursor: pointer;
    }
    .nav-icon {
        font-size: 24px;
        margin-bottom: 5px;
    }
    .nav-text {
        font-size: 12px;
    }
    .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #333;
        padding: 20px;
        border-radius: 10px;
        display: none;
        z-index: 1000;
        max-width: 80%;
        max-height: 80%;
        overflow-y: auto;
    }
    .popup-header {
        font-size: 20px;
        margin-bottom: 10px;
    }
    .popup-close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        color: white;
    }
    .referral-list {
        margin-top: 20px;
    }
    .referral-item {
        margin-bottom: 10px;
        padding: 5px;
        background-color: rgba(255,255,255,0.1);
        border-radius: 5px;
    }
    .store {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: none;
        flex-direction: column;
        overflow-y: auto;
    }
    .store-header {
        position: relative;
        background-color: #4a3000;
        padding: 10px;
        text-align: center;
        font-size: 24px;
        border-bottom: 2px solid #6a4500;
    }
    .upgrade-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #555;
    }
    .upgrade-icon {
        width: 50px;
        height: 50px;
        margin-right: 10px;
        background-color: #555;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
    }
    .upgrade-info {
        flex-grow: 1;
    }
    .upgrade-name {
        font-size: 18px;
        font-weight: bold;
    }
    .upgrade-description {
        font-size: 14px;
        color: #aaa;
    }
    .upgrade-buttons {
        display: flex;
    }
    .buy-button, .info-button {
        padding: 5px 10px;
        margin: 2px;
        background-color: #4a3000;
        border: none;
        color: white;
        cursor: pointer;
    }
    .buy-button:disabled {
        background-color: #333;
        color: #777;
        cursor: not-allowed;
    }
    .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #1a1a1a;
        border: 2px solid #4a4a4a;
        padding: 20px;
        z-index: 1000;
    }
    .popup-header {
        font-size: 24px;
        margin-bottom: 10px;
        color: #fff;
    }
    .popup-close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #fff;
    }
    #achievements-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .achievement-item {
        width: 64px;
        height: 64px;
        background-color: #2a2a2a;
        border: 1px solid #4a4a4a;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    .achievement-item img {
        max-width: 100%;
        max-height: 100%;
    }
    #achievement-description-popup {
        background-color: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 20px;
        border-radius: 10px;
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="cookie-count">0 cookies</div>
            <div class="cps">0/s</div>
        </div>
        <div class="cookie-area">
            <div class="cookie" id="cookie"></div>
        <div class="navbar">
            <div class="nav-item" id="nav-cookie">
                <div class="nav-icon">üç™</div>
                <div class="nav-text">Cookie</div>
            </div>
            <div class="nav-item" id="nav-store">
                <div class="nav-icon">üè™</div>
                <div class="nav-text">Store</div>
            </div>
            <div class="nav-item" id="nav-invite">
                <div class="nav-icon">üì®</div>
                <div class="nav-text">Invite</div>
            </div>
            <div class="nav-item" id="nav-achievements">
                <div class="nav-icon">üèÜ</div>
                <div class="nav-text">Achievements</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon">‚ãØ</div>
                <div class="nav-text">Misc</div>
            </div>
        </div>
    </div>

    <div class="popup" id="invite-popup">
        <div class="popup-header">Invite Friends</div>
        <div class="popup-close">&times;</div>
        <p>Share this link with your friends:</p>
        <input type="text" id="referral-link" readonly>
        <button id="copy-link">Copy Link</button>
        <div class="referral-list" id="referral-list">
            <h3>Your Referrals:</h3>
            <!-- Referral items will be added here dynamically -->
        </div>
    </div>

    <div class="store" id="store">
        <div class="store-header">
            Buildings
            <span class="store-close">&times;</span>
        </div>
        <!-- Building items will be dynamically added here -->
    </div>

    <div class="popup" id="achievements-popup">
        <div class="popup-header">Achievements</div>
        <div class="popup-close">&times;</div>
        <div id="achievements-grid"></div>
    </div>

    <div class="popup" id="achievement-description-popup">
        <div class="popup-close">&times;</div>
        <div id="achievement-description-content"></div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Initialize IndexedDB
        const dbPromise = idb.openDB('CookieClickerDB', 1, {
            upgrade(db) {
                db.createObjectStore('userData', { keyPath: 'userId' });
            },
        });

        document.addEventListener('DOMContentLoaded', function() {
            let cookies = 0;
            let cps = 0;
            const cookieCount = document.querySelector('.cookie-count');
            const cpsDisplay = document.querySelector('.cps');
            const cookie = document.getElementById('cookie');
            const store = document.getElementById('store');
            const navStore = document.getElementById('nav-store');
            const navCookie = document.getElementById('nav-cookie');
            const invitePopup = document.getElementById('invite-popup');
            const navInvite = document.getElementById('nav-invite');
            const popupClose = document.querySelector('.popup-close');
            const referralLink = document.getElementById('referral-link');
            const copyLinkButton = document.getElementById('copy-link');
            const referralList = document.getElementById('referral-list');
            const achievementsPopup = document.getElementById('achievements-popup');
            const achievementsGrid = document.getElementById('achievements-grid');
            const navAchievements = document.getElementById('nav-achievements');
            const achievementDescriptionPopup = document.getElementById('achievement-description-popup');
            const achievementDescriptionContent = document.getElementById('achievement-description-content');

            // Game state
            let gameState = {
                cookies: 0,
                cps: 0,
                buildings: [
                    { name: "Cursor", baseCost: 15, baseCps: 0.1, count: 0 },
                    { name: "Grandma", baseCost: 100, baseCps: 1, count: 0 },
                    { name: "Farm", baseCost: 1100, baseCps: 8, count: 0 },
                    { name: "Mine", baseCost: 12000, baseCps: 47, count: 0 },
                    { name: "Factory", baseCost: 130000, baseCps: 260, count: 0 },
                    { name: "Bank", baseCost: 1400000, baseCps: 1400, count: 0 },
                    { name: "Temple", baseCost: 20000000, baseCps: 7800, count: 0 },
                    { name: "Wizard Tower", baseCost: 330000000, baseCps: 44000, count: 0 },
                    { name: "Shipment", baseCost: 5100000000, baseCps: 260000, count: 0 },
                    { name: "Alchemy Lab", baseCost: 75000000000, baseCps: 1600000, count: 0 },
                    { name: "Portal", baseCost: 1000000000000, baseCps: 10000000, count: 0 },
                    { name: "Time Machine", baseCost: 14000000000000, baseCps: 65000000, count: 0 },
                    { name: "Antimatter Condenser", baseCost: 170000000000000, baseCps: 430000000, count: 0 },
                    { name: "Prism", baseCost: 2100000000000000, baseCps: 2900000000, count: 0 },
                    { name: "Chancemaker", baseCost: 26000000000000000, baseCps: 21000000000, count: 0 },
                    { name: "Fractal Engine", baseCost: 310000000000000000, baseCps: 150000000000, count: 0 },
                    { name: "Javascript Console", baseCost: 71000000000000000000, baseCps: 1100000000000, count: 0 },
                    { name: "Idleverse", baseCost: 12000000000000000000000, baseCps: 8300000000000, count: 0 },
                    { name: "Cortex Baker", baseCost: 1900000000000000000000000, baseCps: 64000000000000, count: 0 },
                    { name: "You", baseCost: 540000000000000000000000000, baseCps: 510000000000000, count: 0 }
                ],
                unlockedAchievements: new Set(),
            };

            // Define achievements
            const achievements = [
                { id: 0, name: "Wake and bake", description: "Bake 1 cookie in one ascension.", icon: "wake_and_bake.png", condition: () => gameState.cookies >= 1 },
                { id: 1, name: "Making some dough", description: "Bake 1,000 cookies in one ascension.", icon: "making_some_dough.png", condition: () => gameState.cookies >= 1000 },
                // ... Add more achievements ...
            ];

            // Load user data
            async function loadUserData() {
                const db = await dbPromise;
                const userId = tg.initDataUnsafe.user.id;
                const userData = await db.get('userData', userId);
                if (userData) {
                    gameState = userData.gameState;
                    gameState.unlockedAchievements = new Set(gameState.unlockedAchievements);
                }
                updateDisplay();
            }

            // Save user data
            async function saveUserData() {
                const db = await dbPromise;
                const userId = tg.initDataUnsafe.user.id;
                await db.put('userData', {
                    userId,
                    gameState: {
                        ...gameState,
                        unlockedAchievements: Array.from(gameState.unlockedAchievements),
                    },
                });
            }

            // Update display
            function updateDisplay() {
                cookieCount.textContent = formatNumber(Math.floor(gameState.cookies)) + ' cookies';
                cpsDisplay.textContent = formatNumber(gameState.cps, 1) + '/s';
                updateBuyButtons();
            }

            function formatNumber(num, decimals = 0) {
                if (num < 1e6) return num.toFixed(decimals);
                const units = ['million', 'billion', 'trillion', 'quadrillion', 'quintillion', 'sextillion', 'septillion'];
                const unit = Math.floor(Math.log(num) / Math.log(1000)) - 1;
                return (num / Math.pow(1000, unit + 1)).toFixed(decimals) + ' ' + units[unit];
            }

            function renderStore() {
                store.innerHTML = `
                    <div class="store-header">
                        Buildings
                        <span class="store-close">&times;</span>
                    </div>
                `;
                gameState.buildings.forEach((building, index) => {
                    const upgradeElement = document.createElement('div');
                    upgradeElement.className = 'upgrade-item';
                    const cost = Math.floor(building.baseCost * Math.pow(1.15, building.count));
                    const currentCps = calculateBuildingCps(index);
                    upgradeElement.innerHTML = `
                        <div class="upgrade-icon">${building.name[0]}</div>
                        <div class="upgrade-info">
                            <div class="upgrade-name">${building.name} (${building.count})</div>
                            <div class="upgrade-description">Produces ${formatNumber(currentCps, 1)} cookies per second.</div>
                        </div>
                        <div class="upgrade-buttons">
                            <button class="buy-button" data-index="${index}">
                                Buy 1 (${formatNumber(cost)} cookies)
                            </button>
                        </div>
                    `;
                    store.appendChild(upgradeElement);
                });
                const closeButton = store.querySelector('.store-close');
                closeButton.addEventListener('click', () => {
                    store.style.display = 'none';
                });
                const buyButtons = store.querySelectorAll('.buy-button');
                buyButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const index = parseInt(button.getAttribute('data-index'));
                        buyBuilding(index);
                    });
                });
                updateBuyButtons();
            }

            function updateBuyButtons() {
                const buyButtons = store.querySelectorAll('.buy-button');
                buyButtons.forEach((button, index) => {
                    const building = gameState.buildings[index];
                    const cost = Math.floor(building.baseCost * Math.pow(1.15, building.count));
                    button.disabled = gameState.cookies < cost;
                    button.textContent = `Buy 1 (${formatNumber(cost)} cookies)`;
                });
            }

            function buyBuilding(index) {
                const building = gameState.buildings[index];
                const cost = Math.floor(building.baseCost * Math.pow(1.15, building.count));
                if (gameState.cookies >= cost) {
                    gameState.cookies -= cost;
                    building.count++;
                    updateDisplay();
                    renderStore();
                }
            }

            function calculateBuildingCps(buildingIndex) {
                const building = gameState.buildings[buildingIndex];
                let cps = building.baseCps;

                const N = gameState.buildings.reduce((sum, b) => sum + b.count, 0);
                const G = gameState.buildings[1].count; // Grandma count
                const C = gameState.buildings[0].count; // Cursor count
                const FE = gameState.buildings[15].count; // Fractal Engine count
                const Po = gameState.buildings[10].count; // Portal count
                const JC = gameState.buildings[16].count; // Javascript Console count

                switch (buildingIndex) {
                    case 0: // Cursor
                        let nonCursorBuildings = N - C;
                        let thousandFingersBonus = 0.1 * nonCursorBuildings;
                        let multiplier = 1;
                        if (gameState.upgrades.tiered[0][3]) { // Thousand fingers
                            multiplier = 1;
                            if (gameState.upgrades.tiered[0][4]) multiplier *= 5; // Million fingers
                            if (gameState.upgrades.tiered[0][5]) multiplier *= 10; // Billion fingers
                            for (let i = 6; i < gameState.upgrades.tiered[0].length; i++) {
                                if (gameState.upgrades.tiered[0][i]) multiplier *= 20;
                            }
                            if (gameState.upgrades.unshackled[0]) multiplier *= 25; // Unshackled cursors
                        }
                        cps += thousandFingersBonus * multiplier;
                        break;
                    case 1: // Grandma
                        cps *= 1 + G/25 + Po/20;
                        cps *= 1 + (N - G)/90.91;
                        cps *= 1 + JC/20;
                        // Additional Grandma-specific upgrades
                        if (gameState.upgrades.grandmaTypes.every(Boolean)) cps *= Math.pow(2, 18);
                        if (gameState.upgrades.research[0]) cps *= 2; // Ritual rolling pins
                        if (gameState.upgrades.research[1]) cps *= 2; // Naughty list
                        if (gameState.upgrades.research[2]) cps *= 4; // Bingo center/Research facility
                        // ... Add other Grandma-specific upgrades here
                        break;
                    default:
                        // For all other buildings
                        let buildingMultiplier = 1;
                        if (buildingIndex >= 2) { // Farm and beyond
                            buildingMultiplier *= 1 + G / (100 * (buildingIndex - 1));
                        }
                        cps *= buildingMultiplier;
                        break;
                }

                // Apply tiered upgrades
                const tieredUpgradeCount = gameState.upgrades.tiered[buildingIndex].filter(Boolean).length;
                cps *= Math.pow(2, tieredUpgradeCount);

                // Apply synergy upgrades
                if (gameState.upgrades.synergies[buildingIndex].some(Boolean)) {
                    cps *= 1.05; // 5% increase per synergy upgrade
                }

                // Apply fortune upgrade
                if (gameState.upgrades.fortune[buildingIndex]) {
                    cps *= 1.07;
                }

                // Apply heavenly upgrades
                if (gameState.upgrades.heavenly[buildingIndex]) {
                    cps *= 1.1; // 10% increase for heavenly upgrades
                }

                return cps * building.count;
            }

            function updateReferralList() {
                referralList.innerHTML = '<h3>Your Referrals:</h3>';
                userData.referrals.forEach(referral => {
                    const referralItem = document.createElement('div');
                    referralItem.className = 'referral-item';
                    referralItem.textContent = `${referral.username} - Earned: ${referral.cookiesEarned} cookies`;
                    referralList.appendChild(referralItem);
                });
            }

            // Check achievements
            function checkAchievements() {
                achievements.forEach(achievement => {
                    if (!gameState.unlockedAchievements.has(achievement.id) && achievement.condition()) {
                        gameState.unlockedAchievements.add(achievement.id);
                        showAchievementNotification(achievement);
                    }
                });
            }

            function showAchievementNotification(achievement) {
                // Implement a notification system to show newly unlocked achievements
                console.log(`Achievement unlocked: ${achievement.name}`);
                // You can use Telegram's native notification here if needed
                tg.showAlert(`Achievement unlocked: ${achievement.name}`);
            }

            function renderAchievements() {
                achievementsGrid.innerHTML = '';
                achievements.forEach(achievement => {
                    const achievementElement = document.createElement('div');
                    achievementElement.className = 'achievement-item';
                    if (gameState.unlockedAchievements.has(achievement.id)) {
                        achievementElement.innerHTML = `<img src="${achievement.icon}" alt="${achievement.name}">`;
                        achievementElement.addEventListener('click', () => showAchievementDescription(achievement));
                    } else {
                        achievementElement.innerHTML = `<img src="locked_achievement.png" alt="Locked">`;
                    }
                    achievementsGrid.appendChild(achievementElement);
                });
            }

            function showAchievementDescription(achievement) {
                achievementDescriptionContent.innerHTML = `
                    <h3>${achievement.name}</h3>
                    <p>${achievement.description}</p>
                `;
                achievementDescriptionPopup.style.display = 'block';
            }

            cookie.addEventListener('click', () => {
                gameState.cookies++;
                updateDisplay();
            });

            navStore.addEventListener('click', () => {
                store.style.display = 'flex';
                renderStore();
            });

            navCookie.addEventListener('click', () => {
                store.style.display = 'none';
            });

            navInvite.addEventListener('click', () => {
                invitePopup.style.display = 'block';
                referralLink.value = `https://cookieclicker.com/ref/${userData.referralCode}`;
                updateReferralList();
            });

            popupClose.addEventListener('click', () => {
                invitePopup.style.display = 'none';
            });

            copyLinkButton.addEventListener('click', () => {
                referralLink.select();
                document.execCommand('copy');
                alert('Referral link copied to clipboard!');
            });

            navAchievements.addEventListener('click', () => {
                achievementsPopup.style.display = 'block';
                renderAchievements();
            });

            document.querySelectorAll('.popup-close').forEach(closeButton => {
                closeButton.addEventListener('click', () => {
                    closeButton.closest('.popup').style.display = 'none';
                });
            });

            achievementDescriptionPopup.addEventListener('click', (event) => {
                if (event.target === achievementDescriptionPopup) {
                    achievementDescriptionPopup.style.display = 'none';
                }
            });

            // Game loop
            setInterval(() => {
                gameState.cookies += gameState.cps / 10;
                updateDisplay();
                checkAchievements();
            }, 100);

            // Save data every 15 seconds
            setInterval(saveUserData, 15000);

            // Initial load
            loadUserData();
        });
    </script>
</body>
</html>